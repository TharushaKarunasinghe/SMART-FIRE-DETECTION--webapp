<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Test - Fire Detection</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-box {
        background: white;
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }
      .error {
        border-left-color: #dc3545;
      }
      .success {
        border-left-color: #28a745;
      }
      .warning {
        border-left-color: #ffc107;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      #log {
        background: #000;
        color: #00ff00;
        padding: 15px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ”¥ Firebase Test - Fire Detection System</h1>

    <div class="test-box">
      <h3>System Status</h3>
      <div>Firebase SDK: <span id="firebaseStatus">âŒ Not Loaded</span></div>
      <div>Config: <span id="configStatus">âŒ Not Loaded</span></div>
      <div>Database: <span id="databaseStatus">âŒ Not Connected</span></div>
      <div>Total Readings: <span id="totalReadings">0</span></div>
    </div>

    <div class="test-box">
      <h3>Test Controls</h3>
      <button onclick="testFirebaseConnection()">ğŸ§ª Test Connection</button>
      <button onclick="writeTestData()">ğŸ“ Write Test Data</button>
      <button onclick="readData()">ğŸ“– Read Data</button>
      <button onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
    </div>

    <div class="test-box">
      <h3>Console Log</h3>
      <div id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Configuration -->
    <script src="config.js"></script>

    <script>
      let database = null;
      let dataRef = null;
      let totalReadings = 0;

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("log");
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      }

      function updateStatus() {
        document.getElementById("firebaseStatus").textContent =
          typeof firebase !== "undefined" ? "âœ… Loaded" : "âŒ Not Loaded";
        document.getElementById("configStatus").textContent =
          typeof firebaseConfig !== "undefined" ? "âœ… Loaded" : "âŒ Not Loaded";
        document.getElementById("databaseStatus").textContent = database
          ? "âœ… Connected"
          : "âŒ Not Connected";
      }

      function initFirebase() {
        log("ğŸ”§ Initializing Firebase...");

        if (typeof firebase === "undefined") {
          log("âŒ Firebase SDK not available");
          return;
        }

        if (typeof firebaseConfig === "undefined") {
          log("âŒ Firebase config not available");
          return;
        }

        try {
          firebase.initializeApp(firebaseConfig);
          database = firebase.database();
          dataRef = database.ref("latest");

          log("âœ… Firebase initialized successfully");
          log("ğŸ“ Database URL: " + firebaseConfig.databaseURL);
          log("ğŸ“‚ Listening to path: /latest");

          // Set up real-time listener
          dataRef.on("value", (snapshot) => {
            const data = snapshot.val();
            const timestamp = new Date().toLocaleTimeString();

            if (data) {
              totalReadings++;
              document.getElementById("totalReadings").textContent =
                totalReadings;
              log(`ğŸ”” [${timestamp}] Data received: ${JSON.stringify(data)}`);
            } else {
              log(`âš ï¸ [${timestamp}] No data in snapshot`);
            }
          });

          updateStatus();
        } catch (error) {
          log("âŒ Firebase initialization failed: " + error.message);
        }
      }

      function testFirebaseConnection() {
        log("ğŸ§ª Testing Firebase connection...");

        if (!database) {
          log("âŒ Database not initialized");
          return;
        }

        // Test read
        dataRef
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();
            log("âœ… Read test successful");
            log("ğŸ“Š Data: " + (data ? JSON.stringify(data) : "null"));
          })
          .catch((error) => {
            log("âŒ Read test failed: " + error.message);
          });
      }

      function writeTestData() {
        log("ğŸ“ Writing test data...");

        if (!dataRef) {
          log("âŒ Database reference not available");
          return;
        }

        const testData = {
          temperature: (20 + Math.random() * 20).toFixed(1),
          humidity: (40 + Math.random() * 40).toFixed(1),
          smoke: Math.floor(Math.random() * 200),
          gas: Math.floor(Math.random() * 500),
          warningLevel: Math.floor(Math.random() * 3),
          warningLabel: ["ALL CLEAR", "WATCH", "CAUTION"][
            Math.floor(Math.random() * 3)
          ],
          timestamp: new Date().toISOString(),
          testMode: true,
        };

        dataRef
          .set(testData)
          .then(() => {
            log("âœ… Test data written successfully");
            log("ğŸ“Š Data: " + JSON.stringify(testData));
          })
          .catch((error) => {
            log("âŒ Write failed: " + error.message);

            if (error.code === "PERMISSION_DENIED") {
              log("ğŸš« PERMISSION DENIED - Check Firebase rules!");
            }
          });
      }

      function readData() {
        log("ğŸ“– Reading current data...");

        if (!dataRef) {
          log("âŒ Database reference not available");
          return;
        }

        dataRef
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();
            if (data) {
              log("ğŸ“Š Current data: " + JSON.stringify(data, null, 2));
            } else {
              log("âš ï¸ No data found at /latest");

              // Check alternative paths
              const paths = ["/readings", "/fireDetection", "/sensors"];
              paths.forEach((path) => {
                database
                  .ref(path)
                  .once("value")
                  .then((snap) => {
                    if (snap.val()) {
                      log(`âœ… Found data at ${path}`);
                    }
                  });
              });
            }
          })
          .catch((error) => {
            log("âŒ Read failed: " + error.message);
          });
      }

      function clearLog() {
        document.getElementById("log").textContent = "";
      }

      // Initialize on load
      document.addEventListener("DOMContentLoaded", function () {
        log("ğŸ“„ Page loaded, initializing...");
        updateStatus();

        setTimeout(() => {
          initFirebase();
        }, 1000);
      });

      // Update status every 2 seconds
      setInterval(updateStatus, 2000);
    </script>
  </body>
</html>
